<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="da">
<!--Dansk sprogattribut-->

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!--Tegnsæt utf-8-->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!--Mobilskalering-->
    <!--<link rel="stylesheet" type="text/css" href="/css/bootstrap.css"> <!--Dist af Bootstrap-->
    <title>Hyponet</title>
    <style type="text/css">
        /* denne farve erstatter den blå markeringsfarve */
        ::selection {
            background: #ffff00;
            color: #000;
        }


        .uddybningsnode {
            background-color: lightgreen;
            line-height: 1.9em;
            font-size: 16px;
            margin: 10px;
            border: 1px #333 solid;
            padding: 5px;
            width: 450px;
        }

        .grundnode {
            background-color: lightcoral;
            line-height: 1.9em;
            font-size: 16px;
            margin: 10px;
            border: 1px #333 solid;
            padding: 5px;
            width: 450px
        }
    </style>

</head>

<body>

    <div class="container-fluid">



        <div class="grundnode">
            <p id="grundnode" contenteditable="true">Skriv noget her</p>
        </div>

        <div id="uddybninger">
            <!--Her lægges uddybningerne-->
        </div>


    </div>






    <script src="https://unpkg.com/neo4j-driver"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <!--Bootstrap og Popper
    <script src="/js/bootstrap.bundle.js"></script>
    -->
    <script type="text/javascript">
        $(function () {

            var TilNoden = {};
            var FraNoden = {};
            var DenNodeViMarkererI = {};

            //Neo4J forbindelse med javascript-driver
            var driver = neo4j.v1.driver(
                'bolt://localhost',
                neo4j.v1.auth.basic('neo4j', '1234567890'))


            //#grundnode
            var grundnode = $("#grundnode");

            //Funktion som sender inputværdien fra #grundnode
            function LavEnGrundnode() {
                // Create a session to run Cypher statements in.
                // Note: Always make sure to close sessions when you are done using them!
                var session = driver.session()

                session
                    //CYPHER-queries som sendes til neo4j
                    .run(
                        "CREATE (n:Root {name:{nameParam} }) SET n.creationTime = timestamp() RETURN n.creationTime, n.name, ID(n), labels(n)", {
                            nameParam: grundnode.text()
                        })
                    .subscribe({
                        onNext: function (record) {
                            
                            FraNoden = {
                                NodensCreationTime: record.get('n.creationTime'),
                                NodensID: record.get('ID(n)'),
                                NodensName: record.get('n.name'),
                                NodensLabels: record.get('labels(n)')
                            }
                            console.log("LavEnGrundnode: " + FraNoden.NodensLabels[0] + " indhold: " + FraNoden.NodensName + "ID: " + FraNoden.NodensID) 


                        },
                        onCompleted: function () {
                            // session.close()
                        },
                        onError: function (error) {
                            console.log(error)
                        }
                    })



            };


            //Funktion som sender inputværdien fra #uddybningsnode[+ creationtime fra neo4j]
            function LavEnSpecnode() {



                // Create a session to run Cypher statements in.
                // Note: Always make sure to close sessions when you are done using them!
                var session = driver.session()

                // Run a Cypher statement, reading the result in a streaming manner as records arrive:
                session

                    .run(
                        "CREATE (n:Specification {name:{nameParam}}) SET n.creationTime = timestamp() RETURN n.creationTime, n.name, ID(n), labels(n)", {
                            nameParam: $('.uddybningsnode').last().text()
                        })
                    .subscribe({
                        onNext: function (record) {
                            
                            FraNoden = {
                                NodensCreationTime: record.get('n.creationTime'),
                                NodensID: record.get('ID(n)'),
                                NodensName: record.get('n.name'),
                                NodensLabels: record.get('labels(n)')
                            }
                            console.log("LavEnSpecNode: " + FraNoden.NodensLabels[0] + " indhold: " + FraNoden.NodensName + "ID: " + FraNoden.NodensID) 
                            //Tildel denne SPEC-node en class = NodensID 
                            //HUSK HUS HUSK Enhver uddybningsnode skal tildeles ID fra neo4j så man senere kan matche noden i neo4j ud fra dette id ifm at man skal oprette nye markeringer fra den.
                            $(this).addClass(record.get('ID(n)'))
                            //Lav en spec-relation til den uddybende node til markeringen
                            LavEnSpecRel()

                        },
                        onCompleted: function () {
                            //session.close()
                        },
                        onError: function (error) {
                            console.log(error)
                        }

                    })




            }

            //Funktion som laver en MARK-relation mellem en ROOT eller en SPEC og en MARK
            function LavEnMarkRel() {

                


                // Create a session to run Cypher statements in.
                // Note: Always make sure to close sessions when you are done using them!
                var session = driver.session()

                // Run a Cypher statement, reading the result in a streaming manner as records arrive:
                session
                    .run(
                        "MATCH (n:" + FraNoden.NodensLabels[0] + " {creationTime:" + FraNoden
                        .NodensCreationTime +
                        ", name:\"" + FraNoden.NodensName +
                        "\"}) MATCH (l:" + TilNoden.NodensLabels[0] + " {creationTime:" + TilNoden
                        .NodensCreationTime + ", name:\"" + TilNoden.NodensName +
                        "\"}) CREATE (n)-[r:MARK]->(l)")
                    .subscribe({
                        onNext: function () {
                            console.log("LavEnMarkRel: " + "Fra " + FraNoden.NodensLabels[0] + " ID: " +
                    FraNoden.NodensID + " Til " + TilNoden.NodensLabels[0] + " ID: " + TilNoden.NodensID);

                        },
                        onCompleted: function () {
                            //session.close()
                        },
                        onError: function (error) {
                            console.log(error)
                        }
                    })
            }

            //Funktion som laver en SPEC-relation mellem MARK og SPEC
            function LavEnSpecRel() {




                // Create a session to run Cypher statements in.
                // Note: Always make sure to close sessions when you are done using them!
                var session = driver.session()

                // Run a Cypher statement, reading the result in a streaming manner as records arrive:
                session
                    .run(
                        "MATCH (n:" + TilNoden.NodensLabels[0] + " {creationTime:" + TilNoden
                        .NodensCreationTime +
                        ", name:\"" + TilNoden.NodensName +
                        "\"}) MATCH (l:" + FraNoden.NodensLabels[0] + " {creationTime:" + FraNoden
                        .NodensCreationTime + ", name:\"" + FraNoden.NodensName +
                        "\"}) CREATE (n)-[r:SPEC]->(l)")
                    .subscribe({
                        onNext: function () {
                            
                        },
                        onCompleted: function () {
                            console.log("LavEnSpecRel: " + "Fra " + TilNoden.NodensLabels[0] + " ID: " +
                    TilNoden.NodensID + " Til " + FraNoden.NodensLabels[0] + " ID: " + FraNoden.NodensID);
                        },
                        onError: function (error) {
                            console.log(error)
                        }
                    })

            }

            //fjern placeholderteksten i #grundnode p-tag
            $(".grundnode").mousedown(function () {
                if (grundnode.text() === "Skriv noget her") {
                    $("#grundnode").text("") //Fjerner indholdet af #grundnoden p-tag
                    console.log("Placeholder Fjernet ")
                };

            });

            //Tillad tryk på ENTER én gang
            var kunDenEneGang = true;
            //Tjek alle taster i #grundnode
            $('#grundnode').keypress(function (e) {
                //submit ved ENTER
                if (e.which == 13 && kunDenEneGang) {
                    //Tillad kun ENTER én gang

                    kunDenEneGang = false;

                    e.preventDefault()

                    console.log("ENTER i #grundnode")
                    //Send input fra Grundnode-input på ENTER
                    LavEnGrundnode()
                }
            });  

            
            //hver gang musen slippes
            $(document).bind("mouseup", function () {

                var tekstenSomBlevMarkeret = '';

                if (!window.x) {
                    x = {};
                }

                x.Selector = {};
                //kør en funktion på det som musen har markeret
                x.Selector.getSelected = function () {

                    if (window.getSelection) {
                        tekstenSomBlevMarkeret = window.getSelection();
                    } else if (document.getSelection) {
                        tekstenSomBlevMarkeret = document.getSelection();
                    } else if (document.selection) {
                        tekstenSomBlevMarkeret = document.selection.createRange().text;
                    }
                    return tekstenSomBlevMarkeret; //funktionen sender t videre
                }

                //Hvis der er markeret noget
                if (x.Selector.getSelected().toString() !='') { //udfør ikke nedenstående hvis der ikke er markeret noget



                    //SEND MARKERING TIL NEO4J
                    var session = driver.session()



                    // Run a Cypher statement, reading the result in a streaming manner as records arrive:
                    session

                        .run(
                            "CREATE (n:Selection {name:{nameParam}}) SET n.creationTime = timestamp() RETURN n.creationTime, n.name, ID(n), labels(n)", {
                                nameParam: $.trim(
                                    tekstenSomBlevMarkeret) //Dette bliver til en Mark-node
                            })
                        .subscribe({
                            onNext: function (record) {

                                //UDDYBNINGSBOKS ÅBNES OG p-tagget tildeles id = ID(n)
                                var uddybningstag = document.createElement(
                                    "p"); //opretter et p-tag
                                //$(uddybningstag).attr("id", record.get(
                                //  'ID(n)')); //tilføjer  id fra markeringsnoden på det oprettede p-tag
                                $(uddybningstag).addClass("uddybningsnode"); //CSS-klasse
                                $(uddybningstag).attr("contenteditable","true"); //tilføjer contenteditable="true" til p-tagget
                                    $()
                                document.getElementById("uddybninger").appendChild(
                                    uddybningstag
                                ); //lægger p-tagget med teksten til div#uddybninger


                                TilNoden = {
                                    NodensCreationTime: record.get('n.creationTime'),
                                    NodensID: record.get('ID(n)'),
                                    NodensName: record.get('n.name'),
                                    NodensLabels: record.get('labels(n)')
                                }


                            },
                            onCompleted: function () {
                                //OVERSTREGNING
                                var tusch = x.Selector
                                    .getSelected(); //Brug overstregningstusch når man slipper musen
                                if (document.selection && !window.getSelection) {
                                    tusch.pasteHTML("<mark id=" + TilNoden.NodensID + ">" +
                                        tusch.htmlText +
                                        "</mark>"); //Farv det valgte med tusch
                                    console.log("markeret på: " + tusch
                                        .htmlText); //fortæller hvad der er blevet markeret
                                } else {
                                    var tusch = tusch.getRangeAt(0)
                                    var nyMarkering = document.createElement("mark");
                                    nyMarkering.setAttribute("id", TilNoden.NodensID);
                                    tusch.surroundContents(nyMarkering)
                                    console.log("markering på: " + tusch
                                        .toString()); //fortæller hvad der er blevet markeret

                                };
                            },
                            onError: function (error) {
                                console.log(error)
                            }
                        })

                

                };

//Tjek alle taster i #uddybningsnode
                //denne selector skabes dynamisk og findes derfor ikke i ready-funktionen.
                $('.uddybningsnode').keypress(function (e) {
                    

                    //submit ved ENTER
                    if (e.which == 13) {
                        e.preventDefault()
                        console.log("ENTER i .uddybningsnode")

                        //Den gamle Franode skal ændres til den nyoprettede nodes ID
                        
                        var session = driver.session()

                        // Run a Cypher statement, reading the result in a streaming manner as records arrive:
                        session.run(
                                "MATCH (n) WHERE ID(n) = " + FraNoden.NodensID +
                                " RETURN n.creationTime, n.name, ID(n), labels(n)")
                            .subscribe({
                                onNext: function (record) {
                                    FraNoden = {
                                        NodensCreationTime: record.get(
                                            'n.creationTime'),
                                        NodensID: record.get('ID(n)'),
                                        NodensName: record.get('n.name'),
                                        NodensLabels: record.get('labels(n)')
                                    }
                                    console.log("Noden af typen: " + FraNoden
                                        .NodensLabels[0] + "med indholdet:" +
                                        FraNoden.NodensName
                                    ) //Viser indhold af objektet


                                },
                                onCompleted: function () {
                                    
                                    //session.close()
                                },
                                onError: function (error) {
                                    console.log(error)
                                }

                            });
                            
                            //Lav en mark-relation til den node der skabte denne SPEC-node
                            LavEnMarkRel()
                        //Send input fra Specnode-input på ENTER
                        LavEnSpecnode()
                        

                    }
                });



            });

        });
    </script>
</body>

</html>