<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="da">
<!--Dansk sprogattribut-->

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!--Tegnsæt utf-8-->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!--Mobilskalering-->
    <!--<link rel="stylesheet" type="text/css" href="/css/bootstrap.css"> <!--Dist af Bootstrap-->
    <title>Hyponet</title>
    <link rel="shortcut icon" type="image/png" href="favicon.ico" />
    <style type="text/css">
        /* denne farve erstatter den blå markeringsfarve */
        ::selection {
            background: #ffff00;
            color: #000;
        }


        .greenbox p {
            background-color: lightgreen;
            line-height: 1.9em;
            font-size: 16px;
            margin: 10px;
            border: 1px #333 solid;
            padding: 5px;
            width: 450px;
        }

        .redbox p {
            background-color: lightcoral;
            line-height: 1.9em;
            font-size: 16px;
            margin: 10px;
            border: 1px #333 solid;
            padding: 5px;
            width: 450px
        }
    </style>

</head>

<body>
    <button id="fjernknap">Tøm vinduet</button>
    <button id="fyldknap">Fyld vinduet fra sidst</button>
    <button id="gemknap">Gem denne samtale</button>
    <button id="NyGrundNodeKnap">Ny kontekst (Ny Grundnode)</button>



    <div class="container-fluid" id="samtale">



        <div class="redbox" id="redbox">
            <p contenteditable="true">Skriv noget her</p>
        </div>

        <div class="greenbox" id="greenbox">
            <p hidden=hidden>Skjult uddybning</p>
        </div>


    </div>

    <script src="https://unpkg.com/neo4j-driver"></script>

    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!--Bootstrap og Popper
    <script src="/js/bootstrap.bundle.js"></script>
    -->
    <script type="text/javascript">
        $(function () {

            $('body').on('click', '#gemknap', function () {

                GemTilLocalstorage();
            })

            $('body').on('click', '#fjernknap', function () {

                FjernAltIDOM()
            })
            $('body').on('click', '#fyldknap', function () {

                HentAltTilDOM()
            })
            $('body').on('click', '#NyGrundNodeKnap', function () {


                let NytPTag = document.createElement("p");
                $(NytPTag).attr("contenteditable", "true");
                if (document.getElementsByClassName("redbox")[0] = undefined) {
                    let NySamtale = document.createElement("div");
                    NySamtale.attr("id", "samtale");
                    NySamtale.attr("class", "container-fluid");
                    document.getElementById("NyGrundNodeKnap").append(NySamtale)
                }
                document.getElementsByClassName("redbox")[0].append(NytPTag);
                SendGrundNode()

            })


            function GemTilLocalstorage() {
                //Hent tidligere indtastninger fra denne browers localstorage
                if (localStorage.getItem("indtastninger") != null) {
                    var indtastninger = localStorage.getItem("indtastninger");
                }
                //Hent JSON
                var indtastninger = JSON.parse(localStorage.getItem("indtastninger"));
                //Skriv til localstorage
                var helehjemmesiden = document.getElementById("samtale").innerHTML;
                localStorage.setItem("indtastninger", helehjemmesiden);
                //Skriv JSON
                localStorage.setItem("indtastninger", JSON.stringify(helehjemmesiden));
                //Erstat HTML med det fra localstorage
            }


            function FjernAltIDOM() {
                document.getElementById("redbox").innerHTML = "";
                document.getElementById("greenbox").innerHTML = "";

            }

            // Retrieve Content
            function HentAltTilDOM() {
                document.getElementById("samtale").innerHTML = JSON.parse(localStorage.getItem(
                    "indtastninger"));
            }


            //Opret forbindelse til neo4j
            //Neo4J forbindelse med javascript-driver
            var driver = neo4j.v1.driver('bolt://localhost', neo4j.v1.auth.basic('neo4j', '123'));
            //Åbn en session
            var session = driver.session()
            //Opret et tekstfelt til grundnoder
            //
            // SKAL LAVES DYNAMISK!!!!
            //
            var grundnodetekstfelt = $(".redbox p")
           



            //Send indhold til neo4j om at oprette en grundnode
            function LavEnGrundnode() {
                session
                    .run(
                        "CREATE (n:Root {name: \"" + $(grundnodetekstfelt).text() +
                        "\" }) SET n.creationTime = timestamp() RETURN n.creationTime, n.name, ID(n), labels(n)"
                    )
                    .subscribe({
                        onNext: function (record) {
                            GrundNoden = {
                                GrundNodensCreationTime: record.get('n.creationTime'),
                                GrundNodensID: record.get('ID(n)'),
                                GrundNodensName: record.get('n.name'),
                                GrundNodensLabels: record.get('labels(n)')
                            }
                        },
                        onCompleted: function () {
                            console.log("LavEnGrundnode: " + GrundNoden.GrundNodensLabels[0] +
                                " indhold: " + GrundNoden.GrundNodensName + " ID: " + GrundNoden
                                .GrundNodensID)

                            HentIDTilGrundnode(GrundNoden)
                            // session.close()
                        },
                        onError: function (error) {
                            console.log(error)
                        }
                    })

            };

            //Skriv i tekstfeltet og Send ved ENTER
            function SendGrundNode() {

                var kunDenEneGang = true;

                grundnodetekstfelt.keypress(function (e) {
                    //submit ved ENTER
                    if (e.which == 13 && kunDenEneGang) {
                        console.log("ENTER i grundnodetekstfeltet")
                        //Tillad kun ENTER én gang
                        kunDenEneGang = false;
                        e.preventDefault()
                        LavEnGrundnode()
                    }
                });

                grundnodetekstfelt.mousedown(function (e) {
                    //fjern placeholderteksten
                    if (grundnodetekstfelt.text() === "Skriv noget her") {
                    grundnodetekstfelt.text("")
                    console.log("Placeholder Fjernet ")
                    };
                    let grundnodetekstfeltet = e.currentTarget.innerText;

                    if (grundnodetekstfeltet !="" && kunDenEneGang && e.currentTarget.id == "") {
                        console.log(
                            "Da der ikke blev trykket ENTER i .redbox, sendes indholdet til databasen"
                            )
                        LavEnGrundnode()
                    }

                });
            }
            //Send grundnode afsted
            SendGrundNode()
            //Hent ID fra neo4j til den samme tekstfelt-opmærkning som netop er oprettet
            function HentIDTilGrundnode(fraGrundnoden) {
                grundnodetekstfelt.attr("id", fraGrundnoden.GrundNodensID)
            }


            //Marker tekst i tekstfeltet
            function SelectTextFromWindow(event) {

                var selectedText = '';
                var NodeWhichIsSelected = event.target;
                if (!window.x) {
                    x = {};
                }
                x.Selector = {};
                x.Selector.getSelected = function () {

                    if (window.getSelection) {
                        selectedText = window.getSelection();
                    } else if (document.getSelection) {
                        selectedText = document.getSelection();
                    } else if (document.selection) {
                        selectedText = document.selection.createRange().text;
                    }
                    return selectedText;
                }
                //udfør kun hvis der ER markeret noget
                if (x.Selector.getSelected().toString() != '') {
                    //Send indholdet, hvis man har glemt at trykke ENTER

                    FjernMarkTag(NodeWhichIsSelected)
                    LavEnMarkNode(selectedText, NodeWhichIsSelected)
                };
            }
            //Opret gule mark-opmærkninger
            // OG
            //Hent ID fra neo4j til den samme mark-opmærkning som netop er oprettet
            function SurroundSelectedTextWithMarkTag(MarkNodeID) {
                var tusch = x.Selector.getSelected();
                if (document.selection && !window.getSelection) {
                    tusch.pasteHTML("<mark id=" + MarkNodeID + ">" +
                        tusch.htmlText +
                        "</mark>"); //Farv det valgte med tusch
                    console.log("markeret på: " + tusch.htmlText);
                } else {
                    var tusch = tusch.getRangeAt(0)
                    var newMarkElement = document.createElement("mark");
                    newMarkElement.setAttribute("id", MarkNodeID);
                    tusch.surroundContents(newMarkElement)
                    console.log("markering på: " + tusch.toString());

                };
            }
            //Send indhold til neo4j om at oprette en marknode
            function LavEnMarkNode(SelectedTextFromWindow, NodeTheSelectionWasMadeIn) {
                session
                    .run(
                        "CREATE (n:Selection {name:{nameParam}}) SET n.creationTime = timestamp() RETURN n.creationTime, n.name, ID(n), labels(n)", {
                            nameParam: $.trim(SelectedTextFromWindow) //Dette bliver til en Mark-node
                        })
                    .subscribe({
                        onNext: function (record) {
                            MARKNoden = {
                                MarkNodensCreationTime: record.get('n.creationTime'),
                                MarkNodensID: record.get('ID(n)'),
                                MarkNodensName: record.get('n.name'),
                                MarkNodensLabels: record.get('labels(n)')
                            }
                        },
                        onCompleted: function () {
                            SurroundSelectedTextWithMarkTag(MARKNoden.MarkNodensID)
                            LavEnMarkRel(NodeTheSelectionWasMadeIn.id, MARKNoden)
                        },
                        onError: function (error) {
                            console.log(error)
                        }
                    })
            }




            //Fjerner mark-tag fra uddybning, så man kan lave en overlappende markering
            //(det er en hack. Jeg vil foretrække at man kan markere flere gange oveni hinanden)
            function FjernMarkTag(DenNodeMarkSkalFjernesFra) {
                console.log("Der prøves at fjerne mark-tag")

                let marktag = document.getElementById(DenNodeMarkSkalFjernesFra.id).getElementsByTagName(
                    'mark');

                while (marktag.length) {
                    let parent = marktag[0].parentNode;
                    while (marktag[0].firstChild) {
                        parent.insertBefore(marktag[0].firstChild, marktag[0]);
                    }
                    parent.removeChild(marktag[0]);
                    console.log("der er fjernet mark-tag i p-tag")

                }
            }




            //Send ved mouseup
            document.querySelector(".redbox").addEventListener("mouseup", function (e) {
                SelectTextFromWindow(e)
                console.log("der er mouseup i .redbox")

            })

            document.querySelector(".greenbox").addEventListener("mouseup", function (e) {
                SelectTextFromWindow(e)
                console.log("der er mouseup i .greenbox")

            })
            // $(".greenbox, .redbox").bind("mouseup", function (event) {SelectTextFromWindow(event)});
            //Send indhold til neo4j om at oprrette en (MARK)relation fra den forrige (grund)node til den indeværende (Mark)node
            function LavEnMarkRel(FraNodensID, TilMarkNode) {
                session
                    .run(
                        `MATCH (n) WHERE (n:Specification OR n:Root) AND ID(n) = ${FraNodensID}
                                MATCH (l: ${TilMarkNode.MarkNodensLabels[0]} {creationTime:${TilMarkNode
                            .MarkNodensCreationTime}, name:"${TilMarkNode.MarkNodensName}"})
                                CREATE (n)-[r:MARK]->(l)`
                    )
                    .subscribe({
                        onNext: function () {},
                        onCompleted: function () {
                            LavEnUddybningsboks(FraNodensID, TilMarkNode)
                            //session.close()
                        },
                        onError: function (error) {
                            console.log(error)
                        }
                    })
                console.log("LavEnMarkRel: " + " ID: " +
                    FraNodensID + " Til " + TilMarkNode.MarkNodensLabels[0] + " ID: " + TilMarkNode
                    .MarkNodensID);
            }
            //Opret et tekstfelt til uddybning (som er en specnode)
            function LavEnUddybningsboks(FraNodensID, MarknodenDenKommerFra) {
                //UDDYBNINGSBOKS ÅBNES

                var NytPTag = document.createElement("p");

                $(NytPTag).attr("contenteditable", "true"); //tilføjer contenteditable="true" til p-tagget

                var ParentNode = document.getElementById(FraNodensID);
                var uddybningsnode = document.getElementById("greenbox");
                

                //Hvis markering foregår i redbox
                if (ParentNode.parentElement == document.getElementById("redbox")) {
                    console.log("Uddybningsboks udspringer fra grundnode")
                    uddybningsnode.append(NytPTag)
                } else {
                    $(NytPTag).insertAfter(ParentNode);
                }
                


                SendSpecNode(MarknodenDenKommerFra);
            }

            //Opret en taleboblehale der går fra uddybningstekstfeltet til den mark-opmærkningen som udløste (uddybnings)tekstfeltet
            //
            //IKKE LAVET ENDNU!!!
            //
            //(GENBRUG) Skriv i tekstfeltet og send ved Enter
            function SendSpecNode(MarknodenDenKommerFra) {
                //Hvis man bruger musen i et grønt felt som IKKE er tomt, så skal den sende til databasen


                var kunDenEneGang = true;

                $(".greenbox p").keypress(function (e) {


                    if (e.which == 13 && kunDenEneGang) {
                        console.log("ENTER i .greenbox")
                        kunDenEneGang = false;
                        e.preventDefault()
                        LavEnSpecnode(MarknodenDenKommerFra, e.currentTarget)
                    }

                });

                $(".greenbox p").mousedown(function (e) {

                                       
                    if (e.currentTarget.innerText != "" && kunDenEneGang && e.currentTarget.id == "") {
                        console.log(
                            "Da der ikke blev trykket ENTER i .greenbox, sendes indholdet til databasen"
                            )
                        LavEnSpecnode(MarknodenDenKommerFra, e.currentTarget)
                        kunDenEneGang = false;
                    }

                });




            }
            //Send indhold til neo4j om at oprette en Spec-node
            function LavEnSpecnode(FraMarkNoden, CurrentGreenBoxWithKeypress) {
                session
                    .run(
                        "CREATE (n:Specification {name:{nameParam}}) SET n.creationTime = timestamp() RETURN n.creationTime, n.name, ID(n), labels(n)", {
                            nameParam: CurrentGreenBoxWithKeypress.innerText
                        })
                    .subscribe({
                        onNext: function (record) {
                            SPECNoden = {
                                SpecNodensCreationTime: record.get('n.creationTime'),
                                SpecNodensID: record.get('ID(n)'),
                                SpecNodensName: record.get('n.name'),
                                SpecNodensLabels: record.get('labels(n)')
                            }

                            console.log("LavEnSpecNode: " + SPECNoden.SpecNodensLabels[0] +
                                " ,indhold: " +
                                SPECNoden.SpecNodensName + " ,ID: " + SPECNoden.SpecNodensID)
                        },
                        onCompleted: function () {
                            //Lav en spec-relation til den uddybende node til markeringen
                            HentIDTilSpecnode(SPECNoden, CurrentGreenBoxWithKeypress)
                            LavEnSpecRel(FraMarkNoden.MarkNodensID, SPECNoden)
                            //session.close()
                        },
                        onError: function (error) {
                            console.log(error)
                        }
                    })
            }
            //(GENBRUG) Hent ID fra neo4j til den samme tekstfelt-opmærkning som netop er oprettet
            function HentIDTilSpecnode(fraSpecnoden, CurrentGreenBoxWithKeypress) {
                $(CurrentGreenBoxWithKeypress).attr("id", fraSpecnoden.SpecNodensID)
            }
            //(GENBRUG) Send indhold til neo4j om at oprrette en (SPEC)relation fra den forrige (mark)node til den indeværende (spec)node
            function LavEnSpecRel(FraMarkNodensID, TilSpecNode) {
                session
                    .run(
                        `MATCH (n) WHERE (n:Selection) AND ID(n)=${FraMarkNodensID} MATCH (l:${TilSpecNode.SpecNodensLabels[0]} {creationTime:${TilSpecNode
                            .SpecNodensCreationTime},name:"${TilSpecNode.SpecNodensName}"}) CREATE (n)-[r:SPEC]->(l)`
                    )
                    .subscribe({
                        onNext: function () {},
                        onCompleted: function () {},
                        onError: function (error) {
                            console.log(error)
                        }
                    })
                console.log("LavEnSpecRel: " + " ID: " + FraMarkNodensID + " Til ID: " + TilSpecNode
                    .SpecNodensID);
            }
            //Ændr et (spec)tekstfelt til et (grundnode)tekstfelt, hvis alt indholdet i et tekstfelt (være spec- eller grund-) slettes ved Delete eller backspace (ikke ved at markere det hele, for det opretter en mark-opmærkning)
            //
            //IKKE LAVET ENDNU
            //
            //(GENBRUG) Send indhold til neo4j om at oprette en grundnode
            //
            //IKKE LAVET ENDNU
            //



        });
    </script>
</body>

</html>